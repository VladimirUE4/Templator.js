var Mark={includes:{},globals:{},delimiter:">",compact:!1,_copy:function(e,n){for(var t in n=n||[],e)n[t]=e[t];return n},_size:function(e){return e instanceof Array?e.length:e||0},_iter:function(e,n){this.idx=e,this.size=n,this.length=n,this.sign="#",this.toString=function(){return this.idx+this.sign.length-1}},_pipe:function(e,n){var t,i,r,o;if(t=n.shift()){r=(i=t.split(this.delimiter)).shift().trim();try{if("blank"===r&&void 0===e)o=Mark.pipes[r].apply(null,[e].concat(i));else{if(void 0===e&&"blank"!==r)return"";o=Mark.pipes[r].apply(null,[e].concat(i))}e=this._pipe(o,n)}catch(e){console.error(`Pipe error in function '${r}': ${e.message}`)}}return e},_eval:function(e,n,t){var i,r,o=this._pipe(e,n),s=o,u=-1;if(null==s)return"";if(o instanceof Array)for(o="",i=s.length;++u<i;)r={iter:new this._iter(u,i)},o+=t?Mark.up(t,s[u],r):s[u];else o instanceof Object&&(o=Mark.up(t,s));return o},_test:function(e,n,t,i){var r=Mark.up(n,t,i).split(/\{\{\s*else\s*\}\}/);return(!1===e?r[1]:r[0])||""},_bridge:function(e,n,t,i){n="."==n?"\\.":n.replace(/\$/g,"\\$");var r,o,s,u=t?t.replace(/([.*+?^=!:${}()|[\]\/\\])/g,"\\$&"):"\\{\\{",c=i?i.replace(/([.*+?^=!:${}()|[\]\/\\])/g,"\\$&"):"\\}\\}",l=new RegExp(u+"\\s*"+n+"([^/}]+\\w*)?"+c+"|"+u+"/"+n+"\\s*"+c,"g"),a=e.match(l)||[],f=0,p=0,g=-1;for(o=0;o<a.length&&(r=o,g=e.indexOf(a[r],g+1),a[r].indexOf(t+"/")>-1?p++:f++,f!==p);o++);return p=(f=e.indexOf(a[0]))+a[0].length,s=g+a[r].length,[e.substring(f,s),e.substring(p,g)]},up:function(e,n,t){n=n||{};var i,r,o,s,u,c,l,a,f,p,g=(t=t||{}).openDelimiter||"{{",h=t.closeDelimiter||"}}",d=new RegExp(g.replace(/([.*+?^=!:${}()|[\]\/\\])/g,"\\$&")+"(.+?)"+h.replace(/([.*+?^=!:${}()|[\]\/\\])/g,"\\$&"),"g"),m=e.match(d)||[],_=[],k=0,v=0;for(t.pipes&&this._copy(t.pipes,this.pipes),t.includes&&this._copy(t.includes,this.includes),t.globals&&this._copy(t.globals,this.globals),t.delimiter&&(this.delimiter=t.delimiter),void 0!==t.compact&&(this.compact=t.compact);i=m[k++];)if(l=void 0,c="",s=i.indexOf("/"+h)>-1,u=0===(r=(r=i.substring(g.length,i.length-(s?h.length+1:h.length))).replace(new RegExp("`(.+?)`","g"),(function(e,t){return Mark.up(g+t+h,n)}))).trim().indexOf("if "),(_=r.split("|")).shift(),r=r.replace(/^\s*if/,"").split("|").shift().trim(),o=u?"if":r.split("|")[0],p=null!=n&&n.hasOwnProperty(r)?n[r]:void 0,u&&!_.length&&(_=["notempty"]),!s&&e.indexOf(g+"/"+o)>-1&&(i=(l=this._bridge(e,o,g,h))[0],c=l[1],k+=i.match(d).length-1),!new RegExp("^"+g.replace(/([.*+?^=!:${}()|[\]\/\\])/g,"\\$&")+"\\s*else\\s*"+h.replace(/([.*+?^=!:${}()|[\]\/\\])/g,"\\$&")+"$").test(i)){if(void 0!==(a=this.globals[r]))l=this._eval(a,_,c);else if(f=this.includes[r])f instanceof Function&&(f=f()),l=this._pipe(Mark.up(f,n,t),_);else if(r.indexOf("#")>-1)t.iter?(t.iter.sign=r,l=this._pipe(t.iter,_)):(console.error("Warning: Missing iterator for # symbol"),l="");else if("."===r)l=this._pipe(n,_);else if(r.indexOf(".")>-1){for(r=r.split("."),(p=Mark.globals[r[0]])?v=1:(v=0,p=n);p&&v<r.length;)p=p[r[v++]];l=this._eval(p,_,c)}else u?l=this._pipe(p,_):p instanceof Array?l=this._eval(p,_,c):c?l=p?Mark.up(c,p,t):void 0:n&&n.hasOwnProperty(r)&&(l=this._pipe(p,_));l instanceof Array&&(l=this._eval(l,_,c)),u&&(l=this._test(l,c,n,t)),e=e.replace(i,void 0===l?"":l)}return this.compact?e.replace(/>\s+</g,"><"):e}};Mark.pipes={empty:function(e){return(!e||0===(e+"").trim().length)&&e},notempty:function(e){return!(!e||!(e+"").trim().length)&&e},blank:function(e,n){return e||0===e?e:n},more:function(e,n){return Mark._size(e)>n&&e},less:function(e,n){return Mark._size(e)<n&&e},ormore:function(e,n){return Mark._size(e)>=n&&e},orless:function(e,n){return Mark._size(e)<=n&&e},between:function(e,n,t){return(e=Mark._size(e))>=n&&e<=t&&e},equals:function(e,n){return e==n&&e},notequals:function(e,n){return e!=n&&e},like:function(e,n){return!!new RegExp(n,"i").test(e)&&e},notlike:function(e,n){return!Mark.pipes.like(e,n)&&e},upcase:function(e){return String(e).toUpperCase()},downcase:function(e){return String(e).toLowerCase()},capcase:function(e){return e.replace(/(?:^|\s)\S/g,(function(e){return e.toUpperCase()}))},chop:function(e,n){return e.length>n?e.substr(0,n)+"...":e},tease:function(e,n){var t=e.split(/\s+/);return t.slice(0,n).join(" ")+(t.length>n?"...":"")},trim:function(e){return e.trim()},pack:function(e){return e.trim().replace(/\s{2,}/g," ")},round:function(e){return Math.round(+e)},clean:function(e){return String(e).replace(/<\/?[^>]+>/gi,"")},size:function(e){return e?e.length:0},length:function(e){return e?e.length:0},reverse:function(e){return[].concat(e).reverse()},join:function(e,n){return e?e.join(n):""},limit:function(e,n,t){return e?e.slice(+t||0,+n+(+t||0)):[]},split:function(e,n){return e?e.split(n||","):[]},choose:function(e,n,t){return e?n:t||""},toggle:function(e,n,t,i){return t.split(",")[n.match(/\w+/g).indexOf(e+"")]||i},sort:function(e,n){if(!e)return[];return[].concat(e).sort(n?function(e,t){return e[n]>t[n]?1:-1}:void 0)},fix:function(e,n){return(+e).toFixed(n)},mod:function(e,n){return+e%+n},divisible:function(e,n){return!(!e||+e%n!=0)&&e},even:function(e){return!(!e||1&+e)&&e},odd:function(e){return!(!e||1&~+e)&&e},number:function(e){return parseFloat(e.replace(/[^\-\d\.]/g,""))},url:function(e){return encodeURI(e)},bool:function(e){return!!e},falsy:function(e){return!e},first:function(e){return e&&0===e.idx},last:function(e){return e&&e.idx===e.size-1},call:function(e,n){return e&&e[n]?e[n].apply(e,[].slice.call(arguments,2)):""},set:function(e,n){return Mark.globals[n]=e,""},log:function(e){return console.log(e),e}},"function"!=typeof String.prototype.trim&&(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),"undefined"!=typeof module&&module.exports?module.exports=Mark:"function"==typeof define&&define.amd&&define((function(){return Mark}));
